<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>izkaypro Changes Summary</title>
<style>
body { font-family: Calibri, Arial, sans-serif; max-width: 800px; margin: 40px auto; line-height: 1.6; }
h1 { color: #333; border-bottom: 2px solid #333; }
h2 { color: #444; margin-top: 30px; }
h3 { color: #555; }
table { border-collapse: collapse; width: 100%; margin: 15px 0; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f0f0f0; }
code { background-color: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: Consolas, monospace; }
ul { margin: 10px 0; }
li { margin: 5px 0; }
</style>
</head>
<body>

<h1>Major Changes Since Original Checkout (v0.1.1)</h1>

<h2>Recent Changes (v0.9.x)</h2>

<h3>KayPLUS 84 ROM Support</h3>
<ul>
<li>Full support for the KayPLUS replacement BIOS on Kaypro 4/84</li>
<li>New <code>kayplus_84</code> model preset with KayPLUS-formatted disks (sector IDs 0-9 on both sides)</li>
<li>Software clock fixup: intercepts BIOS tick routine and patches RAM counters with real wall-clock time from the RTC emulation</li>
<li>KayPLUS boot disk shipped with screen dump hotkey remapped to CTRL-] (avoids conflict with QTerm)</li>
</ul>

<h3>SIO-1 Port A Serial Emulation</h3>
<ul>
<li>Z84C40 SIO Channel A emulation for serial communication on Kaypro 4-84 variants</li>
<li>Host serial port connection via <code>--serial</code> flag (real ports or socat ptys)</li>
<li>8116 Baud Rate Generator emulation (300-19200 baud)</li>
<li>Modem signal support (RTS, DTR, CTS, DCD) via <code>TIOCMSET</code> ioctl</li>
<li>Tx timing model for accurate character pacing</li>
<li>TurboROM compatibility: ports 0x00 and 0x04 gated to RAM mode only to prevent BIOS interference</li>
<li>Tested with QTerm: bidirectional text and Kermit file transfers verified</li>
</ul>

<h3>MM58167A Real-Time Clock Emulation</h3>
<ul>
<li>Full RTC register emulation (read and write) with BCD time counters</li>
<li>Accessed via Z80 PIO at ports 0x20 (CLKADD), 0x22 (CLKCTL), 0x24 (CLKDAT)</li>
<li>Time populated from host system clock on boot; user-set time offsets maintained for session</li>
<li>TurboROM and KayPLUS polled clock display on row 25 works natively</li>
<li>I/O address decoding updated (port mask 0xBF) to include A5 for U26/U27 decoder selection</li>
</ul>

<h3>WD1793 FDC Enhancements</h3>
<ul>
<li>WRITE TRACK (0xF0) support for disk formatting — parses WD1793 format data stream</li>
<li>Multi-sector read/write (m=1) — auto-increments sector register until end of track</li>
<li>WRITE SECTOR with Deleted Data Mark support</li>
<li>Write protect status (S6) reported for read-only disk images</li>
<li>READ ADDRESS stays BUSY for realistic polling duration</li>
<li>Force Interrupt supports all I3-I0 values</li>
<li>Head Loaded (S5) set in Type I command status</li>
<li>Fixed SSDD disk crash when loaded on DSDD-configured machines</li>
<li>Fixed FDC verify corruption for mixed-density formats</li>
</ul>

<h3>NMI Delivery Rework</h3>
<ul>
<li>Two-path delivery: immediate on HALT (standard BIOS), deadline-based fallback for polling programs</li>
<li><code>nmi_vector_is_safe()</code> checks the byte at 0x0066 to detect valid NMI handlers</li>
<li>KayPLUS (unsafe NMI vector) only receives NMI via the HALT path</li>
</ul>

<h3>CPU Speed Control</h3>
<ul>
<li>Press F9 to set CPU clock speed from 1-100 MHz with 0.5 MHz resolution</li>
<li>Also settable via <code>--speed</code> command-line flag</li>
<li>Enter -1 for unlimited speed (default)</li>
</ul>

<h3>25-Row Display</h3>
<ul>
<li>Screen renderer reads CRTC R6 register (displayed rows) instead of hardcoding 24</li>
<li>TurboROM and KayPLUS set R6=25 for status line display</li>
</ul>

<h3>Headless Boot Tests</h3>
<ul>
<li><code>--boot-test</code> flag runs automated boot tests for all Kaypro models</li>
<li>Tests Kaypro II, 4/84, TurboROM, and KayPLUS configurations</li>
</ul>

<h3>CLI Upgrade</h3>
<ul>
<li>Migrated from legacy argument parsing to clap v4 with <code>--param=value</code> style</li>
<li>New flags: <code>--model</code>, <code>--drivea</code>, <code>--driveb</code>, <code>--rom</code>, <code>--speed</code>, <code>--serial</code></li>
<li>Trace flags: <code>--bdos-trace</code>, <code>--sio-trace</code>, <code>--rtc-trace</code>, <code>--trace-all</code></li>
</ul>

<h3>Disk Image Reorganization</h3>
<ul>
<li>Disk images organized into subdirectories: <code>system/</code>, <code>blank_disks/</code>, <code>games/</code>, <code>productivity/</code>, <code>programming/</code>, <code>comm/</code>, <code>utilities/</code></li>
</ul>

<h2>Earlier Changes</h2>

<h3>TOML Configuration System (v0.3.0)</h3>
<ul>
<li>New <code>izkaypro.toml</code> config file for runtime model selection</li>
<li>No recompilation needed to switch between Kaypro models</li>
<li>Supported presets: <code>kaypro_ii</code>, <code>kaypro4_83</code>, <code>kaypro4_84</code>, <code>turbo_rom</code>, <code>custom</code></li>
<li>ROM and disk images loaded from external files with embedded fallbacks</li>
<li>Command-line disk arguments override config file settings</li>
</ul>

<h3>Machine Name Display (v0.3.1)</h3>
<ul>
<li>Top border line now shows centered machine name (e.g., <code>//===Kaypro 4-84===\\</code>)</li>
</ul>

<h3>Kaypro 4-84 Support with SY6545 CRTC (v0.2.0)</h3>
<ul>
<li>New SY6545 CRTC emulation (<code>src/sy6545.rs</code>) for Kaypro 2X/4/84</li>
<li>Port-based VRAM access via transparent addressing protocol</li>
<li>Attribute RAM support (reverse, dim, blink, underline)</li>
<li>Hardware scrolling via R12:R13 start address</li>
</ul>

<h3>TurboROM 3.4 Support (v0.2.1)</h3>
<ul>
<li>ROM shadowing to RAM for ROMs that switch bank modes</li>
<li>Index pulse simulation (FDC status bit 1)</li>
<li>Fixed NMI timing for HALT instruction handling</li>
</ul>

<h2>Bug Fixes</h2>

<h3>ROM Banking Fix (v0.3.0)</h3>
<ul>
<li>Fixed critical bug where .COM programs crashed after loading</li>
<li>ROM reads now correctly return ROM data (not overwritten RAM) when in ROM bank mode</li>
</ul>

<h3>CRTC Cursor Artifact Fix (v0.2.1)</h3>
<ul>
<li>VRAM writes via port 0x1F only accepted when R31 (strobe) is selected</li>
<li>Prevents stray writes after cursor register updates</li>
</ul>

<h3>Memory Mapping Fix</h3>
<ul>
<li>0x3000-0x3FFF treated as regular RAM in CRTC mode (not memory-mapped VRAM)</li>
<li>Fixes display issues in programs like Zork that use this memory region</li>
</ul>

<h2>FDC (WD1793) Enhancements</h2>
<ul>
<li>Added STEP, STEP IN, STEP OUT commands with direction tracking</li>
<li>READ ADDRESS returns physical head position (not software track register)</li>
<li>Index pulse simulation for TurboROM format detection</li>
</ul>

<h2>New Files</h2>

<table>
<tr><th>File</th><th>Purpose</th></tr>
<tr><td><code>src/config.rs</code></td><td>TOML configuration parsing and model presets</td></tr>
<tr><td><code>src/sy6545.rs</code></td><td>SY6545 CRTC emulation</td></tr>
<tr><td><code>src/diagnostics.rs</code></td><td>ROM/RAM/VRAM diagnostic tests</td></tr>
<tr><td><code>izkaypro.toml</code></td><td>Default configuration file</td></tr>
<tr><td><code>AGENTS.md</code></td><td>Technical documentation for AI assistants</td></tr>
</table>

</body>
</html>
